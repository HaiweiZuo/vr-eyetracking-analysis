# 📊 模块7真实数据整合分析报告

> **优化目标**: 从模拟数据转向真实数据提取，构建可配置的RQA参数选择系统  
> **分析时间**: 2025年1月  
> **状态**: 🔍 **需求分析中**

---

## 🎯 **用户优化需求分析**

### **核心需求**
1. **删除模拟数据生成函数**: 移除所有随机数据生成代码
2. **真实数据整合**: 从实际VR实验数据中提取10个归一化属性
3. **多源数据融合**: 整合校准数据、事件分析、RQA结果
4. **RQA参数选择**: 支持不同RQA参数的动态选择
5. **目录结构优化**: 按RQA参数组织存储结果

### **10个目标属性**
```javascript
// 需要从真实数据提取的属性
const targetAttributes = [
    'game_duration_norm',     // 游戏时长（归一化）
    'roi_kw_time_norm',       // 关键词ROI时间
    'roi_inst_time_norm',     // 指示ROI时间  
    'roi_bg_time_norm',       // 背景ROI时间
    'rr_1d_norm',            // RQA 1D递归率
    'det_1d_norm',           // RQA 1D确定性
    'ent_1d_norm',           // RQA 1D熵
    'rr_2d_norm',            // RQA 2D递归率
    'det_2d_norm',           // RQA 2D确定性
    'ent_2d_norm'            // RQA 2D熵
];
```

---

## 📁 **真实数据源分析**

### **数据源映射**
| 属性类别 | 数据源 | 文件路径 | 说明 |
|---------|-------|----------|-----|
| **游戏时长** | 校准数据 | `data/*/calibrated/*/n*q*_preprocessed_calibrated.csv` | 计算总时长并归一化 |
| **ROI特征** | 事件分析 | `data/event_analysis_results/All_ROI_Summary.csv` | KW/INST/BG的FixTime |
| **RQA特征** | RQA管道 | `data/rqa_pipeline_results/*/step1_rqa_calculation/RQA_1D2D_summary_*.csv` | 1D/2D的RR/DET/ENT |

### **数据文件结构**

#### **1. 校准数据** (`*/calibrated/*/*.csv`)
```csv
# 示例：n1q1_preprocessed_calibrated.csv
timestamp,x,y,validity,pupil_diameter
0,512.5,384.2,1,3.45
16,513.1,385.0,1,3.42
...
# 用途：计算game_duration_norm = (last_timestamp - first_timestamp) / max_duration
```

#### **2. ROI事件摘要** (`event_analysis_results/All_ROI_Summary.csv`)
```csv
ADQ_ID,ROI,FixTime,EnterCount,RegressionCount,Group
n1q1,KW_n2q1_4,2.569,4,3,control
n1q1,INST_n2q1_1,0.612,1,0,control
n1q1,BG_n2q1,1.1,3,2,control
# 用途：提取KW/INST/BG的FixTime并归一化
```

#### **3. RQA计算结果** (`rqa_pipeline_results/*/step1_rqa_calculation/RQA_1D2D_summary_*.csv`)
```csv
# 预期字段（需要验证）
session_id,subject_id,task_id,RR_1D,DET_1D,ENT_1D,RR_2D,DET_2D,ENT_2D
# 用途：直接获取RQA指标并归一化
```

---

## 🏗️ **系统架构设计**

### **新的模块7架构**
```
模块7：真实数据整合系统
├── 1. RQA参数选择器
│   ├── 可用参数列表：m2_tau1_eps0.055_lmin2, ...
│   ├── 参数选择界面
│   └── 动态加载对应RQA结果
├── 2. 数据提取引擎
│   ├── 校准数据处理器 → game_duration_norm
│   ├── ROI事件处理器 → roi_*_time_norm (3个)
│   └── RQA结果处理器 → rr_*_norm, det_*_norm, ent_*_norm (6个)
├── 3. 数据整合器
│   ├── 多源数据合并
│   ├── 归一化处理
│   └── 一致性验证
└── 4. 结果存储管理
    ├── 按RQA参数分类存储
    ├── 版本控制
    └── 缓存管理
```

### **目录结构设计**
```
data/
├── normalized_features/          # 当前存在的归一化数据
│   └── normalized_features_summary.csv
├── module7_integrated_results/   # 新建：模块7整合结果
│   ├── m2_tau1_eps0.055_lmin2/  # 按RQA参数命名
│   │   ├── integrated_features_summary.csv
│   │   ├── metadata.json
│   │   └── extraction_log.txt
│   ├── m3_tau2_eps0.1_lmin3/    # 其他RQA参数组合
│   │   └── ...
│   └── available_configs.json    # 可用配置列表
└── [existing data sources...]
```

---

## 🔄 **数据处理流程**

### **Phase 1: 数据收集**
```
1. 扫描available RQA configurations
   ├── 读取 rqa_pipeline_results/ 下的所有目录
   ├── 解析每个metadata.json
   └── 构建可选配置列表

2. 用户选择RQA参数 → 目标配置确定

3. 批量读取三类数据源
   ├── 校准数据：所有 */calibrated/*/*.csv
   ├── ROI事件：event_analysis_results/All_ROI_Summary.csv  
   └── RQA结果：对应参数的RQA_1D2D_summary_*.csv
```

### **Phase 2: 特征提取**
```
For each subject_task (e.g., n1q1, m5q2, ad10q3):

1. game_duration_norm:
   ├── 读取对应的calibrated.csv
   ├── duration = last_timestamp - first_timestamp
   └── normalized = duration / max_duration_across_all

2. roi_*_time_norm (KW/INST/BG):
   ├── 从ROI Summary筛选对应ADQ_ID和ROI类型
   ├── 聚合FixTime (sum or mean)
   └── normalized = fixtime / max_fixtime_per_roi_type

3. rqa_*_norm (RR/DET/ENT for 1D/2D):
   ├── 从RQA Summary匹配session_id
   ├── 提取6个RQA指标原始值
   └── normalized = (value - min) / (max - min)
```

### **Phase 3: 数据整合**
```
1. 合并所有特征 → unified DataFrame
2. 数据验证 → 检查缺失值和异常值
3. 保存结果：
   ├── integrated_features_summary.csv
   ├── metadata.json (参数、时间戳、统计信息)
   └── extraction_log.txt (处理日志)
```

---

## 🎛️ **用户界面设计**

### **模块7增强功能**
```html
<!-- RQA参数选择器 -->
<div class="rqa-config-selector">
    <label>选择RQA参数配置:</label>
    <select id="rqaConfigSelect">
        <option value="m2_tau1_eps0.055_lmin2">m=2, τ=1, ε=0.055, l_min=2</option>
        <option value="m3_tau2_eps0.1_lmin3">m=3, τ=2, ε=0.1, l_min=3</option>
        <!-- 动态生成 -->
    </select>
    <button onclick="loadRealData()">加载真实数据</button>
</div>

<!-- 数据处理状态 -->
<div class="data-processing-status">
    <div class="progress-bar">
        <div class="step">1. 扫描数据源</div>
        <div class="step">2. 提取特征</div>
        <div class="step">3. 数据整合</div>
        <div class="step">4. 保存结果</div>
    </div>
</div>
```

---

## 🚀 **实施计划**

### **Step 1: 清理模拟代码** (立即执行)
- 删除 `generateMockData()`, `generateMockEyeMovementData()`, `generateMockMMSEData()`
- 移除所有 `Math.random()` 相关的数据生成代码

### **Step 2: 数据源分析** (深入调研)
- 读取并分析RQA结果文件的确切字段
- 验证ROI事件数据的完整性
- 确认校准数据的时间戳格式

### **Step 3: 特征提取引擎** (核心开发)
- 实现游戏时长计算器
- 实现ROI特征聚合器
- 实现RQA特征标准化器

### **Step 4: 整合系统** (系统集成)
- 多源数据合并逻辑
- 归一化管道
- 结果验证机制

### **Step 5: 存储管理** (基础设施)
- 创建目录结构
- 实现缓存机制
- 版本控制逻辑

### **Step 6: 用户界面** (前端开发)
- RQA参数选择器
- 数据加载进度条
- 结果预览表格

---

## ❓ **待确认问题**

### **数据格式验证**
1. RQA结果CSV的确切字段名称是什么？
2. ROI事件数据是否包含所有需要的受试者？
3. 校准数据的时间戳单位是什么（毫秒/秒）？

### **归一化策略**
1. 每个特征的归一化方法（Min-Max/Z-Score/自定义）？
2. 归一化的范围是全局（所有组）还是分组（按group_type）？
3. 如何处理缺失值和异常值？

### **性能考虑**
1. 数据处理的预期时间（几秒/几分钟）？
2. 是否需要后台处理和进度指示？
3. 缓存策略如何设计？

---

**🎯 下一步行动**

1. **立即**: 删除所有模拟数据生成函数
2. **分析**: 详细查看RQA结果文件的字段结构
3. **设计**: 确定具体的特征提取算法
4. **开发**: 逐步实现真实数据整合系统

您希望我先从哪个步骤开始？我建议首先删除模拟代码，然后深入分析数据文件的确切结构。