# 🆕 模块8子问题切换功能完成报告

> **开发日期**: 2025年1月  
> **功能**: 在眼动系数与MMSE对比结果表格中增加子问题详细视图切换  
> **状态**: ✅ **开发完成**

---

## 🎯 **功能概述**

### **新增功能**
在模块8的眼动系数与MMSE对比分析基础上，增加了**主问题视图** ↔ **子问题详细视图**的切换功能，允许用户查看：

1. **主问题级别 (Q1-Q5)**: 显示5个大类问题的对比分析
2. **子问题级别**: 显示每个Q下具体小题的详细对比分析

### **MMSE子问题结构**
```
📋 MMSE认知评估子问题详细结构：
Q1 (时间定向) - 4个子问题：
├── Q1-1: 年份 (0-1分)
├── Q1-2: 季节 (0-1分)  
├── Q1-3: 月份 (0-1分)
└── Q1-4: 星期 (0-1分)

Q2 (地点定向) - 4个子问题：
├── Q2-1: 省市区 (0-1分)
├── Q2-2: 街道 (0-1分)
├── Q2-3: 建筑 (0-1分)
└── Q2-4: 楼层 (0-1分)

Q3 (即刻记忆) - 1个问题：
└── Q3-1: 即刻记忆 (0-3分)

Q4 (注意力计算) - 5个子问题：
├── Q4-1: 100-7 (0-1分)
├── Q4-2: 93-7 (0-1分)
├── Q4-3: 86-7 (0-1分)
├── Q4-4: 79-7 (0-1分)
└── Q4-5: 72-7 (0-1分)

Q5 (延迟回忆) - 3个子问题：
├── Q5-1: 词1 (0-1分)
├── Q5-2: 词2 (0-1分)
└── Q5-3: 词3 (0-1分)

总计：17个子问题
```

---

## 🛠️ **技术实现**

### **1. UI界面增强**

#### **新增切换按钮**
```html
<div class="d-flex align-items-center mb-3 flex-wrap gap-2">
    <!-- 原有的个人/群体视图切换按钮 -->
    <button type="button" class="btn btn-outline-primary" id="toggleViewMode" onclick="toggleViewMode()">
        <span data-lang-key="switchToGroupView">切换到群体视图</span>
    </button>
    
    <!-- 新增的主问题/子问题切换按钮 -->
    <button type="button" class="btn btn-outline-info" id="toggleDetailMode" onclick="toggleDetailMode()">
        <span data-lang-key="switchToSubQuestionView">切换到子问题详细视图</span>
    </button>
</div>
```

#### **切换逻辑实现**
- **二维切换组合**: 个人/群体 × 主问题/子问题 = 4种显示模式
- **动态表头**: 根据当前模式自动调整表格列标题
- **智能数据源**: 自动选择对应的数据集进行显示

### **2. 数据结构扩展**

#### **全局变量更新**
```javascript
// 新增详细模式状态
let currentDetailMode = 'main'; // 'main' 或 'subQuestion'

// 扩展对比结果结构
let comparisonResults = { 
    individual: [],      // 个人主问题对比
    group: [],          // 群体主问题对比
    subQuestions: [],   // 个人子问题对比 (新增)
    subQuestionGroups: [] // 群体子问题对比 (新增)
};
```

#### **MMSE数据生成增强**
```javascript
// 原generateTaskMMSEScores函数增强，支持子问题详细分数
return {
    mmse_score: actualScore,
    mmse_max_score: config.max,
    performance_ratio: actualScore / config.max,
    subQuestions: [  // 新增子问题详细信息
        {
            sub_question_id: 'Q1-1',
            sub_question_name: '年份',
            sub_question_score: score,
            sub_question_max_score: maxScore,
            sub_question_performance_ratio: ratio
        }
        // ... 其他子问题
    ]
};
```

### **3. 数据分析逻辑扩展**

#### **performDataComparison函数增强**
```javascript
// 新增子问题个人层面对比
if (mmseRecord.subQuestions) {
    mmseRecord.subQuestions.forEach(subQ => {
        subQuestionResults.push({
            subject_id: eyeRecord.subject_id,
            task_id: eyeRecord.task_id,
            sub_question_id: subQ.sub_question_id,
            sub_question_name: subQ.sub_question_name,
            group_type: eyeRecord.group_type,
            eye_movement_coefficient: eyeRecord.eye_movement_coefficient, // 使用相同的眼动系数
            sub_question_score: subQ.sub_question_score,
            sub_question_max_score: subQ.sub_question_max_score,
            sub_question_performance_ratio: subQ.sub_question_performance_ratio
        });
    });
}

// 新增子问题群体层面对比
const subQuestionGroupResults = [];
groups.forEach(group => {
    allSubQuestions.forEach(subQuestionId => {
        // 计算该组该子问题的平均眼动系数、平均分数、相关系数等
        // ...
    });
});
```

### **4. 表格显示逻辑重构**

#### **动态表头切换**
```javascript
// 根据当前模式更新表头
if (currentDetailMode === 'subQuestion') {
    updateTableHeaderForSubQuestions(tableHead);
} else {
    updateTableHeaderForMainQuestions(tableHead);
}
```

#### **四种显示模式**
1. **个人主问题视图**: 显示每个人在Q1-Q5的眼动系数与MMSE分数对比
2. **群体主问题视图**: 显示各组在Q1-Q5的平均眼动系数与平均MMSE分数对比  
3. **个人子问题视图**: 显示每个人在17个子问题的眼动系数与子问题得分对比
4. **群体子问题视图**: 显示各组在17个子问题的平均对比数据

### **5. 图表可视化增强**

#### **散点图动态适配**
```javascript
// 根据详细模式选择对应的数据和坐标轴标签
if (currentDetailMode === 'subQuestion') {
    // 子问题模式：使用sub_question_performance_ratio作为X轴
    x: item.sub_question_performance_ratio,
    title: 'MMSE子问题完成率'
} else {
    // 主问题模式：使用performance_ratio作为X轴  
    x: item.performance_ratio,
    title: 'MMSE完成率'
}
```

### **6. 多语言支持**

#### **新增翻译配置**
```javascript
// 中文翻译
switchToSubQuestionView: '切换到子问题详细视图',
switchToMainQuestionView: '切换到主问题视图',
subQuestionId: '子问题',
subQuestionName: '子问题名称',
subQuestionScore: '子问题得分',
subQuestionMaxScore: '子问题满分',
// MMSE子问题名称
年份: '年份', 季节: '季节', 月份: '月份', 星期: '星期',
省市区: '省市区', 街道: '街道', 建筑: '建筑', 楼层: '楼层',
即刻记忆: '即刻记忆',
'100-7': '100-7', '93-7': '93-7', '86-7': '86-7', '79-7': '79-7', '72-7': '72-7',
词1: '词1', 词2: '词2', 词3: '词3'

// 英文翻译
switchToSubQuestionView: 'Switch to Sub-Question Detail View',
switchToMainQuestionView: 'Switch to Main Question View',
subQuestionId: 'Sub-Question',
subQuestionName: 'Sub-Question Name',
subQuestionScore: 'Sub-Question Score',
subQuestionMaxScore: 'Sub-Question Max Score',
// MMSE子问题英文名称
年份: 'Year', 季节: 'Season', 月份: 'Month', 星期: 'Day of Week',
省市区: 'Province/City/District', 街道: 'Street', 建筑: 'Building', 楼层: 'Floor',
即刻记忆: 'Immediate Memory',
'100-7': '100-7', '93-7': '93-7', '86-7': '86-7', '79-7': '79-7', '72-7': '72-7',
词1: 'Word 1', 词2: 'Word 2', 词3: 'Word 3'
```

---

## 📊 **功能验证**

### **四种展示模式验证**

#### **1. 个人主问题视图**
- ✅ 显示每个受试者在Q1-Q5的对比数据
- ✅ 表头：受试者ID | 任务 | 组别 | 眼动系数 | MMSE分数 | 满分 | 完成率 | 相关系数

#### **2. 群体主问题视图**  
- ✅ 显示三个组别在Q1-Q5的平均对比数据
- ✅ 表头：任务 | 组别 | 受试者数量 | 平均眼动系数 | 平均MMSE分数 | 满分 | 相关系数 | 标准差

#### **3. 个人子问题视图**
- ✅ 显示每个受试者在17个子问题的对比数据
- ✅ 表头：受试者ID | 子问题 | 子问题名称 | 组别 | 眼动系数 | 子问题得分 | 子问题满分 | 完成率 | 相关系数

#### **4. 群体子问题视图**
- ✅ 显示三个组别在17个子问题的平均对比数据  
- ✅ 表头：子问题 | 子问题名称 | 组别 | 受试者数量 | 平均眼动系数 | 平均子问题得分 | 子问题满分 | 相关系数 | 标准差

### **交互功能验证**

#### **切换按钮功能**
- ✅ **个人/群体切换**: 按钮文本动态更新，数据正确切换
- ✅ **主问题/子问题切换**: 按钮文本动态更新，表头和数据正确切换
- ✅ **组合切换**: 两个切换可以任意组合，4种模式都能正常工作

#### **散点图功能**
- ✅ **主问题模式**: X轴为"MMSE完成率"，显示Q1-Q5数据点
- ✅ **子问题模式**: X轴为"MMSE子问题完成率"，显示17个子问题数据点
- ✅ **图例和标题**: 根据当前模式动态更新
- ✅ **三组颜色**: Control(蓝色)、MCI(黄色)、AD(红色)正确显示

#### **多语言功能**
- ✅ **中英文切换**: 所有新增的UI元素都支持中英文切换
- ✅ **子问题名称翻译**: 17个MMSE子问题名称都有对应的英文翻译
- ✅ **动态文本更新**: 切换语言时按钮文本、表头、图表标签都会更新

---

## 🎯 **用户体验提升**

### **数据分析深度提升**
- **从5个大类** → **17个详细子问题**: 分析粒度提升3.4倍
- **更细致的认知功能评估**: 可以具体到"年份记忆"、"词汇回忆"等认知子功能
- **眼动模式与认知子能力关联**: 发现眼动行为与特定认知子能力的关联模式

### **操作便捷性提升**
- **一键切换**: 无需重新加载数据，瞬间切换视图模式
- **状态保持**: 切换详细模式时保持个人/群体视图状态
- **直观对比**: 同一界面内可快速对比主问题和子问题结果

### **科研价值提升**
- **精细化分析**: 支持认知神经科学的精细化研究需求
- **多维度对比**: 个人×群体×主问题×子问题的四维分析矩阵
- **模式发现**: 有助于发现不同认知障碍类型在特定认知子功能上的差异模式

---

## 🔮 **后续扩展建议**

### **分析功能扩展**
1. **子问题聚类分析**: 基于眼动模式对17个子问题进行聚类，发现认知功能模块
2. **认知路径分析**: 分析受试者在不同认知任务间的眼动转换模式
3. **预测模型**: 基于子问题级别的眼动数据建立认知障碍预测模型

### **可视化增强**
1. **热力图视图**: 以热力图形式展示17个子问题在三个组别间的差异强度
2. **雷达图对比**: 为每个组别生成包含17个维度的认知能力雷达图
3. **时序分析**: 如果有多次测试数据，支持子问题级别的认知变化时序分析

### **导出功能增强**
1. **子问题级别报告**: 生成包含17个子问题详细分析的PDF报告
2. **统计显著性检验**: 为子问题级别的组间差异提供统计检验结果
3. **个性化报告**: 为每个受试者生成个性化的认知能力详细报告

---

## ✅ **开发完成确认**

- [x] **UI界面**: 新增子问题详细视图切换按钮
- [x] **数据结构**: 扩展支持17个子问题的数据存储和处理
- [x] **分析逻辑**: 实现个人和群体层面的子问题对比分析
- [x] **表格显示**: 支持4种显示模式的动态切换
- [x] **图表可视化**: 散点图支持主问题和子问题模式
- [x] **多语言支持**: 完整的中英文翻译覆盖
- [x] **交互逻辑**: 两个切换按钮的组合交互正常工作
- [x] **数据完整性**: 所有子问题数据正确生成和匹配

---

**🎉 模块8子问题切换功能开发完成！**

> 现在用户可以在眼动系数与MMSE对比分析中进行多层次的数据探索：从5个主要认知领域深入到17个具体认知子功能，从个人层面扩展到群体层面，为认知神经科学研究提供了更加精细和全面的分析工具。