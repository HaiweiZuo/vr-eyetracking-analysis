# 🛠️ RQA分析流程问题修复说明

## 📋 **已修复的问题**

### 1️⃣ **特征补充错误 (500错误)**
✅ **修复内容**: 修复了`build_event_aggregates`函数中的列名映射问题
- 原问题: 代码尝试访问`SaccadeAmplitude`列，但实际列名是`Amplitude_deg`
- 解决方案: 添加了智能列名映射，兼容多种命名格式
- 现在支持: `Amplitude_deg`, `SaccadeAmplitude`, `MaxVel`, `SaccadeMaxVel`等

### 2️⃣ **文件存储位置错误**
✅ **修复内容**: 清理了data根目录下的旧文件
- 已删除: `RQA_1D2D_summary_*.csv`, `All_Subjects_RQA_EyeMetrics.csv`
- 新文件将保存在: `data/rqa_pipeline_results/{参数签名}/step{n}_{步骤名}/`

### 3️⃣ **前端参数配置面板**
✅ **确认**: 参数配置面板已正确实现
- 位置: "RQA分析流程" 模块顶部
- 功能: 实时参数调整和签名生成

---

## 🎯 **正确使用流程**

### 步骤1: 访问正确的模块
1. 打开浏览器访问: http://127.0.0.1:8080
2. 点击侧边栏的 **"RQA分析流程"** (不是"RQA渲染")
3. 确认能看到 **"RQA参数配置"** 面板

### 步骤2: 配置参数
在参数配置面板中设置:
- **嵌入维度 (m)**: 默认2 (范围1-10)
- **时间延迟 (τ)**: 默认1 (范围1-20)  
- **递归阈值 (ε)**: 默认0.05 (范围0.001-1)
- **最小线长 (l_min)**: 默认2 (范围1-50)

### 步骤3: 运行分析
- **方式一**: 点击 "运行完整流程" (推荐)
- **方式二**: 逐步点击各个步骤按钮

### 步骤4: 验证结果存储
检查文件是否正确存储在:
```
data/rqa_pipeline_results/m2_tau1_eps0.05_lmin2/
├── step1_rqa_calculation/
├── step2_data_merging/
├── step3_feature_enrichment/
├── step4_statistical_analysis/
└── step5_visualization/
```

---

## 🧪 **测试验证**

### 测试页面
访问: http://127.0.0.1:8080/test_frontend_params.html
- 验证参数配置是否工作
- 测试API调用是否正确
- 检查参数签名生成

### 手动验证
1. 确认data根目录下没有 `RQA_1D2D_summary_*.csv` 文件
2. 运行一个测试分析，确认文件生成在参数特定目录
3. 查看 "历史参数" 功能是否正常

---

## ⚠️ **常见问题**

### Q1: 看不到参数配置面板？
**A**: 确保访问的是 "RQA分析流程" 模块，不是 "RQA渲染" 模块

### Q2: 文件仍然生成在data根目录？
**A**: 确保使用新的API端点，清理浏览器缓存，重启服务器

### Q3: 特征补充仍然失败？
**A**: 检查 `data/event_analysis_results/All_Events.csv` 是否存在且包含数据

### Q4: 参数历史为空？
**A**: 首次运行完整流程后，历史记录才会出现

---

## 🔧 **手动清理命令** (如需要)

```powershell
# 清理根目录下的旧文件
Remove-Item "data/RQA_1D2D_summary_*.csv", "data/All_Subjects_RQA_EyeMetrics.csv" -ErrorAction SilentlyContinue

# 清理旧的统计文件
Remove-Item "data/group_stats_output.csv", "data/multi_level_stats_output.csv" -ErrorAction SilentlyContinue
```

---

## 📞 **下一步操作**

1. **重启服务器** (如果还未重启)
2. **访问主页面** 确认参数配置面板显示
3. **运行测试分析** 验证参数化功能
4. **检查结果存储** 确认文件在正确位置

---

*修复时间: 2025年1月* 